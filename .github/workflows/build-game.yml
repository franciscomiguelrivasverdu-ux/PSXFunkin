name: Build PSX Funkin - CON PSXSDK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Instalar dependencias PSX
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          make \
          gcc \
          gcc-mipsel-linux-gnu \
          binutils-mipsel-linux-gnu \
          mkisofs \
          imagemagick \
          ffmpeg \
          wget \
          git \
          flex \
          bison
        
    - name: Instalar PSXSDK
      run: |
        echo "üì• INSTALANDO PSXSDK..."
        
        # Crear directorio para PSXDEV
        mkdir -p psxdev
        cd psxdev
        
        # Clonar y compilar PSXSDK
        git clone https://github.com/psxdev/psxsdk.git
        cd psxsdk
        make
        sudo make install
        
        # Configurar variables de entorno
        echo "PSXSDK=/usr/local/psxsdk" >> $GITHUB_ENV
        echo "PATH=/usr/local/psxsdk/bin:$PATH" >> $GITHUB_ENV
        
        # Verificar instalaci√≥n
        echo "‚úÖ PSXSDK instalado:"
        ls -la /usr/local/psxsdk/include/ | head -10
        
    - name: Configurar entorno PSX
      run: |
        echo "üîß CONFIGURANDO ENTORNO PSX..."
        
        # Variables de entorno para PSXSDK
        export PSXSDK=/usr/local/psxsdk
        export PATH=/usr/local/psxsdk/bin:$PATH
        
        # Verificar que el compilador funciona
        mipsel-unknown-elf-gcc --version || echo "‚ö†Ô∏è Compilador no disponible"
        
        # Verificar librer√≠as PSX
        echo "üìö Librer√≠as PSX disponibles:"
        find /usr/local/psxsdk -name "*.h" | grep -E "(libetc|libgpu|libcd)" | head -10
        
    - name: Compilar herramientas CR√çTICAS
      run: |
        echo "üî® COMPILANDO HERRAMIENTAS..."
        
        # Compilar img2tim si existe
        if [ -f "tools/img2tim.c" ]; then
          echo "üì¶ Compilando img2tim..."
          gcc -o tools/img2tim tools/img2tim.c -lm
        fi
        
        # Compilar vagconv si existe  
        if [ -f "tools/vagconv.c" ]; then
          echo "üîä Compilando vagconv..."
          gcc -o tools/vagconv tools/vagconv.c -lm
        fi
        
    - name: Compilar juego PRINCIPAL (CON PSXSDK)
      run: |
        echo "üéÆ COMPILANDO CON PSXSDK..."
        
        # Configurar entorno
        export PSXSDK=/usr/local/psxsdk
        export PATH=/usr/local/psxsdk/bin:$PATH
        
        # Verificar que las librer√≠as PSX est√°n disponibles
        echo "üîç Buscando librer√≠as PSX..."
        if [ -f "/usr/local/psxsdk/include/libetc.h" ]; then
          echo "‚úÖ libetc.h encontrado"
        else
          echo "‚ùå libetc.h NO encontrado"
          find /usr/local/psxsdk -name "*.h" | head -20
        fi
        
        # Compilar con variables expl√≠citas
        echo "üöÄ Compilando juego..."
        if [ -f "Makefile.psx" ]; then
          make -f Makefile.psx clean
          PSXSDK=/usr/local/psxsdk make -f Makefile.psx
        else
          echo "‚ùå Makefile.psx no encontrado"
          exit 1
        fi
        
    - name: Verificar resultados compilaci√≥n
      run: |
        echo "üìä VERIFICANDO COMPILACI√ìN..."
        
        if [ -f "PSXFNKN.BIN" ]; then
          echo "‚úÖ PSXFNKN.BIN creado exitosamente!"
          ls -la PSXFNKN.BIN
          file PSXFNKN.BIN
          # Copiar a ISO
          cp PSXFNKN.BIN iso/PSXFNKN.BIN
        else
          echo "‚ùå PSXFNKN.BIN no se cre√≥"
          echo "Buscando archivos de salida..."
          find . -name "*.BIN" -o -name "*.bin" -o -name "*.ELF" -o -name "*.elf" | head -10
          exit 1
        fi
        
    - name: Crear ISO Booteable
      run: |
        echo "üìÄ CREANDO ISO..."
        
        # Verificar contenido ISO
        echo "üìÅ Contenido de iso/:"
        ls -la iso/ || echo "No se pudo listar iso/"
        
        # Crear ISO
        mkisofs -o PSXFunkin.iso \
          -sysid "PLAYSTATION" \
          -volid "PSXFNKN" \
          -V "PSXFNKN" \
          -J -r -l \
          iso/
        
        if [ -f "PSXFunkin.iso" ]; then
          echo "‚úÖ ISO creado: PSXFunkin.iso"
          ls -la PSXFunkin.iso
        else
          echo "‚ùå Error creando ISO"
          exit 1
        fi
        
    - name: Subir artifacts
      uses: actions/upload-artifact@v4
      with:
        name: psx-funkin-build
        path: |
          PSXFunkin.iso
          *.BIN
          *.ELF
        retention-days: 7
