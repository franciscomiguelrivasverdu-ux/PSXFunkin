name: Build PSX Game

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential make gcc git wget ffmpeg imagemagick python3 python3-pip unzip
        
    - name: Install PSX Toolchain and PSY-Q
      run: |
        echo "üîß INSTALANDO TOOLCHAIN PSX COMPLETO..."
        
        # Instalar compilador MIPS
        sudo apt-get install -y gcc-mipsel-linux-gnu binutils-mipsel-linux-gnu
        
        # Descargar e instalar PSY-Q SDK
        wget -O psyq-sdk.zip "https://github.com/grumpycoders/pcsx-redux/raw/main/tools/psyq/psyq-sdk.zip"
        unzip -q psyq-sdk.zip -d /usr/local/psyq/
        
        # Configurar variables de entorno
        echo "PSXSDK=/usr/local/psyq" >> $GITHUB_ENV
        echo "CPATH=/usr/local/psyq/include:$CPATH" >> $GITHUB_ENV
        echo "LIBRARY_PATH=/usr/local/psyq/lib:$LIBRARY_PATH" >> $GITHUB_ENV
        
        echo "‚úÖ Toolchain y PSY-Q instalados"
        
    - name: Build asset tools
      run: |
        echo "üî® COMPILANDO HERRAMIENTAS..."
        # Solo construir si existen los Makefiles
        for makefile in Makefile.tools Makefile.tim Makefile.mus; do
          if [ -f "$makefile" ]; then
            make -f "$makefile" || echo "‚ö†Ô∏è  Error con $makefile, continuando..."
          fi
        done
        echo "‚úÖ Herramientas compiladas"
        
    - name: Build the game (with PSY-Q)
      run: |
        echo "üéÆ COMPILANDO JUEGO CON PSY-Q..."
        
        # Configurar entorno para PSY-Q
        export PSXSDK=/usr/local/psyq
        export CPATH=$PSXSDK/include:$CPATH
        export LIBRARY_PATH=$PSXSDK/lib:$LIBRARY_PATH
        
        # Buscar y verificar archivos de PSY-Q
        echo "üîç Buscando librer√≠as PSY-Q..."
        find /usr/local/psyq -name "libetc.h" -o -name "*.a" | head -10
        
        # Compilar
        if [ -f "Makefile.psx" ]; then
          echo "üìÅ Usando Makefile.psx"
          make -f Makefile.psx PSX=1 PSYQ=1
        elif [ -f "Makefile" ]; then
          echo "üìÅ Usando Makefile" 
          make PSX=1 PSYQ=1
        else
          echo "‚ùå No se encontr√≥ Makefile"
          exit 1
        fi
        
    - name: List generated files
      run: |
        echo "üìÅ ARCHIVOS GENERADOS:"
        find . -maxdepth 2 -name "*.bin" -o -name "*.cue" -o -name "*.exe" -o -name "*.elf" | head -20
        
    - name: Upload PSX Game
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: psx-game-build
        path: |
          *.bin
          *.cue
          *.elf
