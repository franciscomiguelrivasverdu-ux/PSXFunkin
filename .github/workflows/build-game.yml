name: Build PSX Funkin - VERSIÃ“N FUNCIONAL

on:
  workflow_dispatch:
    inputs:
      skip_assets:
        description: 'Saltar conversiÃ³n de assets'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Instalar dependencias PSX
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          make \
          gcc \
          gcc-mipsel-linux-gnu \
          binutils-mipsel-linux-gnu \
          mkisofs \
          imagemagick \
          ffmpeg
        
    - name: Analizar estructura del proyecto
      run: |
        echo "ðŸ“ ESTRUCTURA DEL PROYECTO:"
        find . -type f -name "*.c" -o -name "*.h" -o -name "Makefile*" | head -20
        echo ""
        echo "ðŸŽ¨ ASSETS EXISTENTES:"
        find iso -type f 2>/dev/null | head -20 || echo "No hay assets en iso/"
        echo ""
        echo "ðŸ”§ HERRAMIENTAS:"
        find tools -type f 2>/dev/null | head -20 || echo "No hay herramientas"
        
    - name: Compilar herramientas CRÃTICAS
      run: |
        echo "ðŸ”¨ COMPILANDO HERRAMIENTAS ESENCIALES..."
        
        # Compilar img2tim si existe
        if [ -f "tools/img2tim.c" ]; then
          echo "ðŸ“¦ Compilando img2tim..."
          gcc -o tools/img2tim tools/img2tim.c -lm
        fi
        
        # Compilar vagconv si existe  
        if [ -f "tools/vagconv.c" ]; then
          echo "ðŸ”Š Compilando vagconv..."
          gcc -o tools/vagconv tools/vagconv.c -lm
        fi
        
        # Verificar quÃ© herramientas tenemos
        echo "âœ… Herramientas compiladas:"
        ls -la tools/ 2>/dev/null || echo "No se pudo acceder a tools/"
        
    - name: Compilar juego PRINCIPAL
      run: |
        echo "ðŸŽ® COMPILANDO EJECUTABLE PRINCIPAL..."
        
        # Verificar Makefiles disponibles
        echo "ðŸ“‹ Makefiles disponibles:"
        ls -la Makefile* 2>/dev/null || echo "No hay Makefiles"
        
        # Compilar con el Makefile correcto
        if [ -f "Makefile.psx" ]; then
          echo "ðŸš€ Usando Makefile.psx..."
          make -f Makefile.psx clean
          make -f Makefile.psx
        elif [ -f "Makefile" ]; then
          echo "ðŸš€ Usando Makefile principal..."
          make clean
          make
        else
          echo "âŒ No se encontrÃ³ Makefile"
          exit 1
        fi
        
        # Verificar que se creÃ³ el BIN
        if [ -f "PSXFNKN.BIN" ]; then
          echo "âœ… PSXFNKN.BIN creado exitosamente!"
          ls -la PSXFNKN.BIN
          # Mover a carpeta ISO
          cp PSXFNKN.BIN iso/PSXFNKN.BIN
        else
          echo "âš ï¸ PSXFNKN.BIN no se creÃ³, buscando alternativas..."
          find . -name "*.BIN" -o -name "*.bin" | head -10
        fi
        
    - name: Procesar assets EXISTENTES (solo si hay assets fuente)
      if: ${{ github.event.inputs.skip_assets != 'true' }}
      run: |
        echo "ðŸŽ¨ PROCESANDO ASSETS..."
        
        # Verificar si hay assets para procesar
        if [ -d "assets" ]; then
          echo "ðŸ“ Carpeta assets encontrada, procesando..."
          
          # Crear estructura de destino si no existe
          mkdir -p iso/ASSETS
          
          # Procesar imÃ¡genes si existen
          if find assets -name "*.png" | grep -q .; then
            echo "ðŸ–¼ï¸ Procesando PNGs..."
            find assets -name "*.png" | while read png; do
              name=$(basename "$png" .png)
              echo "Converting $name"
              if [ -f "tools/img2tim" ]; then
                tools/img2tim "$png" "iso/ASSETS/${name}.TIM"
              else
                # ConversiÃ³n bÃ¡sica como fallback
                convert "$png" "iso/ASSETS/${name}.TIM" 2>/dev/null || true
              fi
            done
          fi
          
          # Procesar audio si existe
          if find assets -name "*.wav" | grep -q .; then
            echo "ðŸ”Š Procesando audio..."
            find assets -name "*.wav" | while read wav; do
              name=$(basename "$wav" .wav)
              echo "Converting $name"
              if [ -f "tools/vagconv" ]; then
                tools/vagconv "$wav" "iso/ASSETS/${name}.VAG"
              else
                # ConversiÃ³n bÃ¡sica con ffmpeg
                ffmpeg -i "$wav" -acodec pcm_s16le "iso/ASSETS/${name}.VAG" 2>/dev/null || true
              fi
            done
          fi
        else
          echo "â„¹ï¸ No hay carpeta 'assets', usando assets preexistentes"
        fi
        
        echo "ðŸ“Š Assets finales en ISO:"
        find iso -type f | head -20
        
    - name: Crear ISO Booteable
      run: |
        echo "ðŸ“€ CREANDO ISO PSX..."
        
        # Verificar contenido de la carpeta ISO
        echo "ðŸ“ Contenido de ISO/:"
        ls -la iso/ || echo "No se pudo listar iso/"
        
        # Crear ISO
        mkisofs -o PSXFunkin.iso \
          -sysid "PLAYSTATION" \
          -volid "PSXFNKN" \
          -V "PSXFNKN" \
          -J -r -l \
          iso/
        
        # Verificar ISO creado
        if [ -f "PSXFunkin.iso" ]; then
          echo "âœ… ISO creado exitosamente!"
          ls -la PSXFunkin.iso
          echo "TamaÃ±o: $(du -h PSXFunkin.iso | cut -f1)"
        else
          echo "âŒ Error: No se pudo crear el ISO"
          exit 1
        fi
        
    - name: Verificar build FINAL
      run: |
        echo "ðŸŽ¯ VERIFICACIÃ“N FINAL"
        echo "===================="
        
        # Archivos crÃ­ticos
        echo "ðŸ“‹ Archivos generados:"
        ls -la *.iso *.BIN *.bin 2>/dev/null || echo "No hay archivos de build"
        
        # TamaÃ±o total
        echo "ðŸ“Š TamaÃ±o del build:"
        du -sh . 2>/dev/null || echo "No se pudo calcular tamaÃ±o"
        
        # Estructura ISO
        echo "ðŸŒ³ Estructura del ISO:"
        isoinfo -l -i PSXFunkin.iso 2>/dev/null || echo "No se puede leer ISO"
        
    - name: Subir artifacts
      uses: actions/upload-artifact@v4
      with:
        name: psx-funkin-build
        path: |
          PSXFunkin.iso
          *.BIN
          *.bin
        retention-days: 7
