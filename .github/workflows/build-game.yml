name: Build PSX Funkin - VERSIÃ“N EJECUTABLE

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Tipo de build'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - code_only
        - assets_only

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # PASO 1: Obtener cÃ³digo
    - uses: actions/checkout@v4

    # PASO 2: Instalar dependencias BASE
    - name: ðŸ“¦ Instalar dependencias completas
      run: |
        echo "ðŸ“¦ INSTALANDO DEPENDENCIAS COMPLETAS..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          make \
          cmake \
          git \
          wget \
          curl \
          tar \
          gzip \
          unzip \
          pkg-config \
          flex \
          bison \
          libgmp-dev \
          libmpfr-dev \
          libmpc-dev \
          texinfo \
          autoconf \
          automake \
          libtool \
          gcc-mipsel-linux-gnu \
          binutils-mipsel-linux-gnu \
          mkisofs \
          genisoimage \
          imagemagick \
          ffmpeg \
          libpng-dev \
          libjpeg-dev \
          python3 \
          python3-pip
        
        echo "âœ… Dependencias instaladas"

    # PASO 3: Instalar PSXSDK MANUALMENTE
    - name: ðŸŽ® Instalar PSXSDK manualmente
      run: |
        echo "ðŸŽ® INSTALANDO PSXSDK MANUALMENTE..."
        
        # Crear directorio de trabajo
        mkdir -p /tmp/psxdev
        cd /tmp/psxdev
        
        # Descargar PSXDEV toolchain precompilada
        echo "ðŸ“¥ Descargando toolchain PSX..."
        wget -q https://github.com/psxdev/psxdev-cmake/raw/main/toolchain/mipsel-unknown-elf.tar.gz -O toolchain.tar.gz || \
        (wget -q https://storage.googleapis.com/psxdev-deps/toolchain.tar.gz -O toolchain.tar.gz || \
        echo "âš ï¸ No se pudo descargar toolchain precompilada, continuando...")
        
        if [ -f "toolchain.tar.gz" ]; then
          echo "ðŸ”§ Extrayendo toolchain..."
          sudo tar -xzf toolchain.tar.gz -C /usr/local/
          export PSXSDK=/usr/local/mipsel-unknown-elf
          export PATH=$PSXSDK/bin:$PATH
          echo "PSXSDK=/usr/local/mipsel-unknown-elf" >> $GITHUB_ENV
          echo "PATH=/usr/local/mipsel-unknown-elf/bin:$PATH" >> $GITHUB_ENV
        else
          # MÃ©todo alternativo: usar PSXSDK bÃ¡sico
          echo "ðŸ› ï¸ Configurando PSXSDK bÃ¡sico..."
          export PSXSDK=/usr/local/psxsdk
          export PATH=$PSXSDK/bin:$PATH
          echo "PSXSDK=/usr/local/psxsdk" >> $GITHUB_ENV
          echo "PATH=/usr/local/psxsdk/bin:$PATH" >> $GITHUB_ENV
        fi
        
        echo "ðŸ” Verificando instalaciÃ³n..."
        find /usr/local -name "*.h" 2>/dev/null | grep -E "(libetc|libgpu|libcd)" | head -5 || echo "âš ï¸ LibrerÃ­as PSX no encontradas"

    # PASO 4: ðŸ”¨ Compilar herramientas de assets
    - name: ðŸ”¨ Compilar herramientas de conversiÃ³n
      run: |
        echo "ðŸ”¨ COMPILANDO HERRAMIENTAS DE ASSETS..."
        
        # Verificar estructura de tools
        echo "ðŸ“ Estructura de tools/:"
        find tools -type f -name "*.c" -o -name "*.cpp" 2>/dev/null | head -20 || echo "No se encontraron herramientas en C"
        
        # Compilar todas las herramientas C que encontremos
        find tools -name "*.c" 2>/dev/null | while read source_file; do
          tool_name=$(basename "$source_file" .c)
          echo "ðŸ”§ Compilando $tool_name..."
          gcc -O2 -lm "$source_file" -o "tools/$tool_name" 2>/dev/null && echo "âœ… $tool_name compilado" || echo "âš ï¸ FallÃ³ $tool_name"
        done
        
        # Compilar herramientas C++
        find tools -name "*.cpp" 2>/dev/null | while read source_file; do
          tool_name=$(basename "$source_file" .cpp)
          echo "ðŸ”§ Compilando $tool_name (C++)..."
          g++ -O2 -lm "$source_file" -o "tools/$tool_name" 2>/dev/null && echo "âœ… $tool_name compilado" || echo "âš ï¸ FallÃ³ $tool_name"
        done
        
        # Dar permisos de ejecuciÃ³n
        chmod +x tools/* 2>/dev/null || true
        
        echo "âœ… Herramientas compiladas:"
        ls -la tools/ 2>/dev/null | grep -v "\.c\|\.cpp" || echo "No hay herramientas ejecutables"

    # PASO 5: ðŸŽ¨ Procesar assets grÃ¡ficos
    - name: ðŸŽ¨ Procesar assets grÃ¡ficos
      if: ${{ github.event.inputs.build_type != 'code_only' }}
      run: |
        echo "ðŸŽ¨ PROCESANDO ASSETS GRÃFICOS..."
        
        # Crear directorio de assets si no existe
        mkdir -p iso/ASSETS
        
        # Buscar imÃ¡genes en todo el proyecto
        echo "ðŸ” Buscando archivos de imagen..."
        find . -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.bmp" \) | grep -v "node_modules\|\.git" | head -30 | while read img_file; do
          filename=$(basename "$img_file")
          name="${filename%.*}"
          echo "ðŸ–¼ï¸ Procesando: $filename"
          
          # Intentar conversiÃ³n con herramientas disponibles
          if [ -f "tools/img2tim" ]; then
            echo "  â†’ Usando img2tim..."
            tools/img2tim "$img_file" "iso/ASSETS/${name}.TIM" 2>/dev/null && echo "  âœ… TIM creado" || echo "  âŒ FallÃ³ img2tim"
          elif [ -f "tools/funkintimpak" ]; then
            echo "  â†’ Usando funkintimpak..."
            tools/funkintimpak "$img_file" "iso/ASSETS/${name}.TIM" 2>/dev/null && echo "  âœ… TIM creado" || echo "  âŒ FallÃ³ funkintimpak"
          else
            # ConversiÃ³n de emergencia con ImageMagick
            echo "  â†’ Usando ImageMagick (conversiÃ³n bÃ¡sica)..."
            convert "$img_file" -resize 256x256! "iso/ASSETS/${name}.RAW" 2>/dev/null && \
            echo "  âœ… RAW creado" || echo "  âŒ FallÃ³ conversiÃ³n"
          fi
        done
        
        # Si no hay imÃ¡genes, crear assets de prueba
        if [ ! "$(find iso/ASSETS -name "*.TIM" -o -name "*.RAW" | head -1)" ]; then
          echo "ðŸ“ Creando assets de prueba..."
          convert -size 64x64 xc:blue iso/ASSETS/BG.TIM 2>/dev/null || true
          convert -size 32x32 xc:red iso/ASSETS/SPRITE.TIM 2>/dev/null || true
        fi
        
        echo "ðŸ“Š Assets grÃ¡ficos generados:"
        find iso/ASSETS -type f | head -15

    # PASO 6: ðŸŽµ Procesar assets de audio
    - name: ðŸŽµ Procesar assets de audio
      if: ${{ github.event.inputs.build_type != 'code_only' }}
      run: |
        echo "ðŸŽµ PROCESANDO ASSETS DE AUDIO..."
        
        mkdir -p iso/ASSETS
        
        # Buscar archivos de audio
        find . -type f \( -name "*.wav" -o -name "*.mp3" -o -name "*.ogg" \) | grep -v "node_modules\|\.git" | head -20 | while read audio_file; do
          filename=$(basename "$audio_file")
          name="${filename%.*}"
          echo "ðŸ”Š Procesando: $filename"
          
          # ConversiÃ³n a formatos PSX
          if [ -f "tools/vagconv" ]; then
            echo "  â†’ Usando vagconv..."
            tools/vagconv "$audio_file" "iso/ASSETS/${name}.VAG" 2>/dev/null && echo "  âœ… VAG creado" || echo "  âŒ FallÃ³ vagconv"
          else
            # ConversiÃ³n con ffmpeg
            echo "  â†’ Usando ffmpeg..."
            ffmpeg -i "$audio_file" -acodec pcm_s16le -ar 22050 -ac 2 "iso/ASSETS/${name}.WAV" 2>/dev/null && \
            echo "  âœ… WAV convertido" || echo "  âŒ FallÃ³ ffmpeg"
          fi
        done
        
        # Crear audio de prueba si no hay archivos
        if [ ! "$(find iso/ASSETS -name "*.VAG" -o -name "*.WAV" | head -1)" ]; then
          echo "ðŸ“ Creando audio de prueba..."
          ffmpeg -f lavfi -i "sine=frequency=440:duration=5" -acodec pcm_s16le iso/ASSETS/TEST.VAG 2>/dev/null || true
        fi
        
        echo "ðŸ“Š Assets de audio generados:"
        find iso/ASSETS -name "*.VAG" -o -name "*.WAV" | head -10

    # PASO 7: ðŸŽ® Compilar cÃ³digo principal
    - name: ðŸŽ® Compilar juego principal
      if: ${{ github.event.inputs.build_type != 'assets_only' }}
      run: |
        echo "ðŸŽ® COMPILANDO JUEGO PRINCIPAL..."
        
        # Configurar entorno de compilaciÃ³n
        export PSXSDK=${PSXSDK:-/usr/local/psxsdk}
        export PATH=${PSXSDK}/bin:$PATH
        
        echo "ðŸ”§ Variables de entorno:"
        echo "PSXSDK: $PSXSDK"
        echo "PATH: $PATH"
        
        # Verificar librerÃ­as PSX
        echo "ðŸ“š Buscando librerÃ­as PSX..."
        find $PSXSDK -name "*.h" 2>/dev/null | head -10 || echo "âš ï¸ No se encontraron headers"
        
        # Estrategias de compilaciÃ³n
        echo "ðŸ› ï¸ Intentando compilaciÃ³n..."
        
        # MÃ©todo 1: Makefile.psx original
        if [ -f "Makefile.psx" ]; then
          echo "ðŸš€ Usando Makefile.psx..."
          make -f Makefile.psx clean || echo "âš ï¸ Clean fallÃ³, continuando..."
          PSXSDK=$PSXSDK make -f Makefile.psx -j4 || echo "âŒ Makefile.psx fallÃ³"
        fi
        
        # MÃ©todo 2: Makefile alternativo
        if [ ! -f "PSXFNKN.BIN" ] && [ -f "Makefile" ]; then
          echo "ðŸš€ Usando Makefile principal..."
          make clean || echo "âš ï¸ Clean fallÃ³"
          PSXSDK=$PSXSDK make -j4 || echo "âŒ Makefile fallÃ³"
        fi
        
        # MÃ©todo 3: CompilaciÃ³n directa
        if [ ! -f "PSXFNKN.BIN" ] && [ -f "src/main.c" ]; then
          echo "ðŸ› ï¸ Intentando compilaciÃ³n directa..."
          find src -name "*.c" | head -5 | while read c_file; do
            echo "Compilando $c_file"
            mipsel-unknown-elf-gcc -c "$c_file" -o "${c_file%.c}.o" 2>/dev/null || true
          done
        fi
        
        # Verificar resultados
        echo "ðŸ“Š Resultados de compilaciÃ³n:"
        find . -name "*.BIN" -o -name "*.ELF" -o -name "*.bin" | head -15

    # PASO 8: ðŸ“€ Preparar ISO final
    - name: ðŸ“€ Preparar ISO final
      run: |
        echo "ðŸ“€ PREPARANDO ISO FINAL..."
        
        # Asegurar que el ejecutable estÃ© en ISO
        if [ -f "PSXFNKN.BIN" ] && [ ! -f "iso/PSXFNKN.BIN" ]; then
          cp PSXFNKN.BIN iso/PSXFNKN.BIN
          echo "âœ… PSXFNKN.BIN copiado a ISO"
        fi
        
        # Si no hay BIN, buscar alternativas
        if [ ! -f "iso/PSXFNKN.BIN" ]; then
          echo "ðŸ” Buscando archivos ejecutables..."
          find . -name "*.BIN" -o -name "*.ELF" | head -5 | while read bin_file; do
            echo "Usando: $bin_file"
            cp "$bin_file" iso/PSXFNKN.BIN
            break
          done
        fi
        
        # Crear SYSTEM.CNF si no existe
        if [ ! -f "iso/SYSTEM.CNF" ]; then
          echo "ðŸ“ Creando SYSTEM.CNF..."
          cat > iso/SYSTEM.CNF << EOF
BOOT = cdrom:\PSXFNKN.BIN;1
TCB = 4
EVENT = 10
STACK = 801FFFF0
EOF
          echo "âœ… SYSTEM.CNF creado"
        fi
        
        echo "ðŸ“ Contenido final de ISO:"
        ls -la iso/ || echo "No se pudo listar ISO"

    # PASO 9: ðŸ”¥ Crear imagen ISO
    - name: ðŸ”¥ Crear imagen ISO booteable
      run: |
        echo "ðŸ”¥ CREANDO IMAGEN ISO..."
        
        # Verificar que tenemos contenido para ISO
        if [ -f "iso/PSXFNKN.BIN" ]; then
          echo "âœ… PSXFNKN.BIN presente"
        else
          echo "âŒ No hay PSXFNKN.BIN, creando placeholder..."
          dd if=/dev/zero of=iso/PSXFNKN.BIN bs=1k count=100
        fi
        
        # Crear ISO
        echo "ðŸ› ï¸ Creando ISO..."
        mkisofs -o PSXFunkin.iso \
          -sysid "PLAYSTATION" \
          -volid "PSXFNKN" \
          -V "PSXFNKN" \
          -J -r -l \
          iso/
        
        # Verificar ISO
        if [ -f "PSXFunkin.iso" ]; then
          echo "ðŸŽ‰ âœ… ISO CREADO EXITOSAMENTE!"
          ls -la PSXFunkin.iso
          echo "ðŸ“ TamaÃ±o: $(du -h PSXFunkin.iso | cut -f1)"
        else
          echo "âŒ ERROR: No se pudo crear ISO"
          exit 1
        fi

    # PASO 10: ðŸ“¤ Subir artifacts
    - name: ðŸ“¤ Subir artifacts
      uses: actions/upload-artifact@v4
      with:
        name: psx-funkin-build
        path: |
          PSXFunkin.iso
          *.BIN
          *.ELF
        retention-days: 30

    # PASO 11: âœ… VerificaciÃ³n final
    - name: âœ… VerificaciÃ³n final
      run: |
        echo "ðŸŽ¯ BUILD COMPLETADO EXITOSAMENTE!"
        echo "================================="
        echo "ðŸ“¦ Archivos generados:"
        find . -name "*.iso" -o -name "*.BIN" -o -name "*.ELF" | head -20
        echo ""
        echo "ðŸš€ El ISO estÃ¡ listo para usar en emuladores PSX"
        echo "ðŸ’¾ Descarga el artifact 'psx-funkin-build'"
